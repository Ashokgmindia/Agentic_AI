<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMI Agentic AI Framework | Multimodal Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@13.0.0/marked.min.js"></script>
    <style>
        .prose h1, .prose h2, .prose h3 {
            border-left: 4px solid #3b82f6;
            padding-left: 1rem;
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        .prose h1 { font-size: 1.875rem; }
        .prose h2 { font-size: 1.5rem; }
        .prose hr {
            border-top: 1px solid #d1d5db;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .prose ol, .prose ul {
            padding-left: 1.5rem;
        }

        .chat-box::-webkit-scrollbar {
            width: 8px;
        }
        .chat-box::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .chat-box::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        .recording {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            cursor: pointer;
            display: block;
            padding: 1rem;
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            text-align: center;
            transition: all 0.3s;
            background-color: #f8fafc;
        }

        .file-input-label:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .file-input-label.drag-over {
            border-color: #3b82f6;
            background-color: #dbeafe;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen font-sans text-gray-800">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-800 mb-3">GMI Agentic AI Framework</h1>
            <p class="text-lg text-slate-600 max-w-2xl mx-auto">Transform any idea into execution-ready project plans. Upload files, enter text, or record audio for comprehensive AI analysis.</p>
        </div>

        <!-- Main Interface -->
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <!-- Chat Interface -->
            <div id="chat-box" class="chat-box bg-slate-50 rounded-xl p-6 border border-slate-200 shadow-inner max-h-[60vh] overflow-y-auto mb-6">
                <div class="chat-bubble flex justify-start mb-4">
                    <div class="bg-white text-slate-800 p-4 rounded-xl max-w-[80%] shadow-md">
                        <div class="flex items-center mb-2">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                                <span class="text-white font-bold text-sm">AI</span>
                            </div>
                            <span class="font-semibold text-slate-700">GMI Stakeholder Agent</span>
                        </div>
                        <p>Hello! I'm ready to transform your ideas into structured project plans. You can:</p>
                        <ul class="mt-2 text-sm text-slate-600">
                            <li>• Upload any file type (PDF, images, audio, spreadsheets, etc.)</li>
                            <li>• Enter text descriptions of your ideas</li>
                            <li>• Record audio directly using your microphone</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Input Interface -->
            <div class="space-y-4">
                <!-- Text Input -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Project Idea or Description</label>
                    <textarea 
                        id="textInput" 
                        rows="4" 
                        placeholder="Describe your idea, project requirements, or business concept..."
                        class="w-full border border-slate-300 rounded-lg p-4 text-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 resize-none placeholder-slate-400"
                    ></textarea>
                </div>

                <!-- File Input -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Upload File (Any Format)</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" accept="*/*">
                        <label for="fileInput" class="file-input-label" id="fileLabel">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-slate-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <span class="text-slate-600 font-medium">Click to upload or drag & drop</span>
                                <span class="text-sm text-slate-400 mt-1">Supports: PDF, Images, Audio, CSV, Excel, Word, PPT, Text</span>
                            </div>
                        </label>
                    </div>
                    <div id="fileInfo" class="mt-2 text-sm text-slate-600 hidden"></div>
                </div>

                <!-- Audio Recording -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Voice Recording</label>
                    <div class="flex space-x-3">
                        <button 
                            id="recordButton" 
                            class="flex-1 bg-red-500 text-white p-4 rounded-lg font-medium hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300 transition-all duration-200 flex items-center justify-center"
                        >
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                            </svg>
                            Start Recording
                        </button>
                        <button 
                            id="stopButton" 
                            class="px-6 bg-gray-400 text-white p-4 rounded-lg font-medium cursor-not-allowed"
                            disabled
                        >
                            Stop
                        </button>
                    </div>
                    <div id="recordingStatus" class="mt-2 text-sm text-slate-600 hidden"></div>
                </div>

                <!-- Submit Button -->
                <button 
                    id="analyzeButton"
                    class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 rounded-lg font-bold text-lg hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-200 transform hover:scale-105 shadow-lg"
                >
                    Start GMI Analysis
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let mediaRecorder;
        let recordedBlobs = [];
        let isRecording = false;
        let currentFile = null;

        // Elements
        const textInput = document.getElementById('textInput');
        const fileInput = document.getElementById('fileInput');
        const fileLabel = document.getElementById('fileLabel');
        const fileInfo = document.getElementById('fileInfo');
        const recordButton = document.getElementById('recordButton');
        const stopButton = document.getElementById('stopButton');
        const recordingStatus = document.getElementById('recordingStatus');
        const analyzeButton = document.getElementById('analyzeButton');
        const chatBox = document.getElementById('chat-box');

        // File handling
        fileInput.addEventListener('change', handleFileSelect);
        fileLabel.addEventListener('dragover', handleDragOver);
        fileLabel.addEventListener('dragleave', handleDragLeave);
        fileLabel.addEventListener('drop', handleFileDrop);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                currentFile = file;
                updateFileInfo(file);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            fileLabel.classList.add('drag-over');
        }

        function handleDragLeave() {
            fileLabel.classList.remove('drag-over');
        }

        function handleFileDrop(event) {
            event.preventDefault();
            fileLabel.classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                currentFile = files[0];
                fileInput.files = files;
                updateFileInfo(files);
            }
        }

        function updateFileInfo(file) {
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            fileInfo.innerHTML = `<strong>Selected:</strong> ${file.name} (${fileSize} MB)`;
            fileInfo.classList.remove('hidden');
        }

        // Audio recording
        recordButton.addEventListener('click', startRecording);
        stopButton.addEventListener('click', stopRecording);

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                recordedBlobs = [];
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data && event.data.size > 0) {
                        recordedBlobs.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedBlobs, { type: 'audio/wav' });
                    const file = new File([blob], `recording_${Date.now()}.wav`, { type: 'audio/wav' });
                    
                    // Create a virtual file input
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    fileInput.files = dt.files;
                    currentFile = file;
                    
                    updateFileInfo(file);
                };

                mediaRecorder.start();
                isRecording = true;
                
                recordButton.textContent = 'Recording...';
                recordButton.classList.add('recording');
                recordButton.disabled = true;
                stopButton.disabled = false;
                stopButton.classList.remove('cursor-not-allowed', 'bg-gray-400');
                stopButton.classList.add('bg-red-500', 'hover:bg-red-600');
                
                recordingStatus.textContent = 'Recording in progress... Click stop when finished.';
                recordingStatus.classList.remove('hidden');

            } catch (error) {
                console.error('Error accessing microphone:', error);
                addMessage('Error: Could not access microphone. Please check permissions.', 'agent', 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                isRecording = false;
                recordButton.textContent = 'Start Recording';
                recordButton.classList.remove('recording');
                recordButton.disabled = false;
                stopButton.disabled = true;
                stopButton.classList.add('cursor-not-allowed', 'bg-gray-400');
                stopButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                
                recordingStatus.textContent = 'Recording completed and ready for analysis.';
            }
        }

        // Analysis submission
        analyzeButton.addEventListener('click', async () => {
            const text = textInput.value.trim();
            const file = fileInput.files[0];

            if (!text && !file) {
                addMessage('Please provide either text input or upload a file to analyze.', 'agent', 'error');
                return;
            }

            // Show user message
            let userMessage = '';
            if (text) userMessage += `<strong>Text:</strong> "${text}"`;
            if (file) userMessage += (userMessage ? '<br>' : '') + `<strong>File:</strong> ${file.name} (${file.type || 'Unknown type'})`;
            
            addMessage(userMessage, 'user');

            // Show processing message
            const processingId = addMessage('🔄 GMI Stakeholder Agent is analyzing your input...', 'agent', 'processing');

            try {
                const formData = new FormData();
                if (file) formData.append('file', file);
                if (text) formData.append('text', text);

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.final_markdown) {
                    const formattedMarkdown = marked.parse(data.final_markdown);
                    updateMessage(processingId, `<div class="prose max-w-none">${formattedMarkdown}</div>`, 'agent');
                } else {
                    updateMessage(processingId, `❌ Analysis failed: ${data.error}`, 'agent', 'error');
                }

            } catch (error) {
                updateMessage(processingId, `❌ Network error: ${error.message}`, 'agent', 'error');
            }

            // Reset form
            textInput.value = '';
            fileInput.value = '';
            currentFile = null;
            fileInfo.classList.add('hidden');
            recordingStatus.classList.add('hidden');
        });

        // Chat functions
        function addMessage(content, sender, type = 'normal') {
            const messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-4`;
            messageDiv.id = messageId;

            const contentDiv = document.createElement('div');
            contentDiv.className = `p-4 rounded-xl max-w-[85%] shadow-md transition-all duration-300`;

            if (sender === 'user') {
                contentDiv.classList.add('bg-blue-600', 'text-white');
                contentDiv.innerHTML = content;
            } else {
                contentDiv.classList.add('bg-white', 'text-slate-800');
                
                if (type === 'processing') {
                    contentDiv.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                                <span class="text-white font-bold text-sm">AI</span>
                            </div>
                            <div>
                                <div class="font-semibold text-slate-700 mb-1">GMI Stakeholder Agent</div>
                                <div class="animate-pulse">${content}</div>
                            </div>
                        </div>
                    `;
                } else if (type === 'error') {
                    contentDiv.classList.remove('bg-white', 'text-slate-800');
                    contentDiv.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200');
                    contentDiv.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center mr-3">
                                <span class="text-white font-bold text-sm">!</span>
                            </div>
                            <div>
                                <div class="font-semibold text-red-700 mb-1">Error</div>
                                <div>${content}</div>
                            </div>
                        </div>
                    `;
                } else {
                    contentDiv.innerHTML = `
                        <div class="flex items-start">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3 mt-1">
                                <span class="text-white font-bold text-sm">AI</span>
                            </div>
                            <div class="flex-1">
                                <div class="font-semibold text-slate-700 mb-2">GMI Stakeholder Agent</div>
                                <div>${content}</div>
                            </div>
                        </div>
                    `;
                }
            }

            messageDiv.appendChild(contentDiv);
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            return messageId;
        }

        function updateMessage(id, content, sender, type = 'normal') {
            const messageDiv = document.getElementById(id);
            if (messageDiv) {
                const contentDiv = messageDiv.querySelector('div');
                if (contentDiv) {
                    contentDiv.classList.remove('animate-pulse');
                    if (sender === 'agent' && type === 'normal') {
                        contentDiv.innerHTML = `
                            <div class="flex items-start">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3 mt-1">
                                    <span class="text-white font-bold text-sm">AI</span>
                                </div>
                                <div class="flex-1">
                                    <div class="font-semibold text-slate-700 mb-2">GMI Stakeholder Agent</div>
                                    <div>${content}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        contentDiv.innerHTML = content;
                    }
                }
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>
